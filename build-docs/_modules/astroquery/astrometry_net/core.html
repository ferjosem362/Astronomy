<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>astroquery.astrometry_net.core &#8212; astroquery v0.4.7.dev9024</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-astropy.css?v=9d21690f" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    
    <script src="../../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../../_static/documentation_options.js?v=4195d067"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="icon" href="../../../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">astro</span><span id="logotext2">query</span><span id="logotext3">:docs</span></a>
  <ul>
    
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">astroquery v0.4.7.dev9024</a>
	 &#187;
      </li>
      <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for astroquery.astrometry_net.core</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>


<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">sigma_clipped_stats</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">astropy.nddata</span> <span class="kn">import</span> <span class="n">CCDData</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">_HAVE_CCDDATA</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">_HAVE_CCDDATA</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">photutils.detection</span> <span class="kn">import</span> <span class="n">DAOStarFinder</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">_HAVE_SOURCE_DETECTION</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">_HAVE_SOURCE_DETECTION</span> <span class="o">=</span> <span class="kc">True</span>

<span class="kn">from</span> <span class="nn">..query</span> <span class="kn">import</span> <span class="n">BaseQuery</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">async_to_sync</span><span class="p">,</span> <span class="n">url_helpers</span>
<span class="kn">from</span> <span class="nn">..exceptions</span> <span class="kn">import</span> <span class="ne">TimeoutError</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">conf</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="c1"># export all the public classes and methods</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AstrometryNet&#39;</span><span class="p">,</span> <span class="s1">&#39;AstrometryNetClass&#39;</span><span class="p">]</span>


<span class="n">MISSING_API_KEY</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Astrometry.net API key not set. You should either set this in the astroquery configuration file using:</span>

<span class="s2">    [astrometry_net]</span>
<span class="s2">    api_key = ADD_YOUR_API_KEY_HERE</span>

<span class="s2">or you can set it for this session only using the ``conf`` object:</span>

<span class="s2">    from astroquery.astrometry_net import conf</span>
<span class="s2">    conf.api_key = &#39;ADD_YOUR_API_KEY_HERE&#39;</span>

<span class="s2">or using the ``api_key`` property on the ``AstrometryNet`` class:</span>

<span class="s2">    from astroquery.astrometry_net import AstrometryNet</span>
<span class="s2">    AstrometryNet.api_key = &#39;ADD_YOUR_API_KEY_HERE&#39;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>


<div class="viewcode-block" id="AstrometryNetClass">
<a class="viewcode-back" href="../../../api/astroquery.astrometry_net.AstrometryNetClass.html#astroquery.astrometry_net.AstrometryNetClass">[docs]</a>
<span class="nd">@async_to_sync</span>
<span class="k">class</span> <span class="nc">AstrometryNetClass</span><span class="p">(</span><span class="n">BaseQuery</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform queries to the astrometry.net service to fit WCS to images</span>
<span class="sd">    or source lists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">URL</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">server</span>
    <span class="n">TIMEOUT</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">timeout</span>
    <span class="n">API_URL</span> <span class="o">=</span> <span class="n">url_helpers</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="s1">&#39;api&#39;</span><span class="p">)</span>

    <span class="c1"># These are drawn from https://astrometry.net/doc/net/api.html#submitting-a-url</span>
    <span class="n">_constraints</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;allow_commercial_use&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;allowed&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">)},</span>
        <span class="s1">&#39;allow_modifications&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;allowed&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">)},</span>
        <span class="s1">&#39;publicly_visible&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;allowed&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">)},</span>
        <span class="s1">&#39;scale_units&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;allowed&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;degwidth&#39;</span><span class="p">,</span> <span class="s1">&#39;arcminwidth&#39;</span><span class="p">,</span> <span class="s1">&#39;arcsecperpix&#39;</span><span class="p">)},</span>
        <span class="s1">&#39;scale_type&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;allowed&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;ev&#39;</span><span class="p">,</span> <span class="s1">&#39;ul&#39;</span><span class="p">)},</span>
        <span class="s1">&#39;scale_lower&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;allowed&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)},</span>
        <span class="s1">&#39;scale_upper&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;allowed&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)},</span>
        <span class="s1">&#39;scale_est&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;allowed&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)},</span>
        <span class="s1">&#39;scale_err&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;allowed&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)},</span>
        <span class="s1">&#39;center_ra&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;allowed&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">)},</span>
        <span class="s1">&#39;center_dec&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;allowed&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">)},</span>
        <span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;allowed&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)},</span>
        <span class="s1">&#39;downsample_factor&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;allowed&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)},</span>
        <span class="s1">&#39;tweak_order&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;allowed&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)},</span>
        <span class="s1">&#39;use_sextractor&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="s1">&#39;allowed&#39;</span><span class="p">:</span> <span class="p">()},</span>
        <span class="s1">&#39;crpix_center&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="s1">&#39;allowed&#39;</span><span class="p">:</span> <span class="p">()},</span>
        <span class="s1">&#39;parity&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;allowed&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)},</span>
        <span class="s1">&#39;positional_error&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;allowed&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)},</span>
    <span class="p">}</span>

    <span class="n">_no_source_detector</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">_HAVE_SOURCE_DETECTION</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">api_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the Astrometry.net API key. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="o">.</span><span class="n">api_key</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">MISSING_API_KEY</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conf</span><span class="o">.</span><span class="n">api_key</span>

    <span class="nd">@api_key</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">api_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Temporarily set the API key. &quot;&quot;&quot;</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">empty_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a dict of settings using the defaults</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

<div class="viewcode-block" id="AstrometryNetClass.show_allowed_settings">
<a class="viewcode-back" href="../../../api/astroquery.astrometry_net.AstrometryNetClass.html#astroquery.astrometry_net.AstrometryNetClass.show_allowed_settings">[docs]</a>
    <span class="k">def</span> <span class="nf">show_allowed_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        There are a ton of options available for solving. This displays</span>
<span class="sd">        them in a nice way.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">key_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{key}</span><span class="s1">: type </span><span class="si">{type!r}</span><span class="s1">, &#39;</span>
                  <span class="s1">&#39;default value </span><span class="si">{default}</span><span class="s1">, &#39;</span>
                  <span class="s1">&#39;allowed values </span><span class="si">{values}</span><span class="s1">&#39;</span>
                  <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                            <span class="nb">type</span><span class="o">=</span><span class="n">key_info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="n">key_info</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">],</span>
                            <span class="n">values</span><span class="o">=</span><span class="n">key_info</span><span class="p">[</span><span class="s1">&#39;allowed&#39;</span><span class="p">]))</span></div>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session_id</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">login_url</span> <span class="o">=</span> <span class="n">url_helpers</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">API_URL</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_payload</span><span class="p">({</span><span class="s1">&#39;apikey&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">})</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="n">login_url</span><span class="p">,</span>
                               <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
                               <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">result_dict</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">result_dict</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unable to log in to astrometry.net&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session_id</span> <span class="o">=</span> <span class="n">result_dict</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_construct_payload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;request-json&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">settings</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">_validate_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether the current settings are consistent with the choices available</span>
<span class="sd">        from astrometry.net.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check the types and values</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span> <span class="ow">or</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Setting </span><span class="si">{}</span><span class="s1"> is not allowed. Display all of &#39;</span>
                           <span class="s1">&#39;the allowed settings with: &#39;</span>
                           <span class="s1">&#39;AstrometryNet.show_allowed_settings()&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]):</span>
                <span class="n">failed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># Try coercing the type...</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">](</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">failed</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">failed</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Value for </span><span class="si">{}</span><span class="s1"> must be of type </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]))</span>
            <span class="c1"># Switching on the types here...not fond of this, but it works.</span>
            <span class="n">allowed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;allowed&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">allowed</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="c1"># Allowed values is a list of choices.</span>
                    <span class="n">good_value</span> <span class="o">=</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;allowed&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
                    <span class="c1"># bool is easy to check...</span>
                    <span class="n">good_value</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Assume the parameter is a number which has a minimum and</span>
                    <span class="c1"># optionally a maximum.</span>
                    <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;allowed&#39;</span><span class="p">]</span>
                    <span class="n">good_value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">good_value</span> <span class="o">=</span> <span class="n">good_value</span> <span class="ow">and</span> <span class="n">good_value</span> <span class="o">&lt;=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="c1"># No upper bound to check</span>
                        <span class="k">pass</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">good_value</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Value </span><span class="si">{}</span><span class="s1"> for </span><span class="si">{}</span><span class="s1"> is invalid. &#39;</span>
                                     <span class="s1">&#39;The valid &#39;</span>
                                     <span class="s1">&#39;values are </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">allowed</span><span class="p">))</span>
        <span class="c1"># Check some special cases, in which the presence of one value means</span>
        <span class="c1"># others are needed.</span>
        <span class="k">if</span> <span class="s1">&#39;scale_type&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="n">scale_type</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;scale_type&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">scale_type</span> <span class="o">==</span> <span class="s1">&#39;ev&#39;</span><span class="p">:</span>
                <span class="n">required_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scale_est&#39;</span><span class="p">,</span> <span class="s1">&#39;scale_err&#39;</span><span class="p">,</span> <span class="s1">&#39;scale_units&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">required_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scale_lower&#39;</span><span class="p">,</span> <span class="s1">&#39;scale_upper&#39;</span><span class="p">,</span> <span class="s1">&#39;scale_units&#39;</span><span class="p">]</span>
            <span class="n">good</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">req</span> <span class="ow">in</span> <span class="n">settings</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">required_keys</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">good</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Scale type </span><span class="si">{}</span><span class="s1"> requires &#39;</span>
                                 <span class="s1">&#39;values for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scale_type</span><span class="p">,</span> <span class="n">required_keys</span><span class="p">))</span>

<div class="viewcode-block" id="AstrometryNetClass.monitor_submission">
<a class="viewcode-back" href="../../../api/astroquery.astrometry_net.AstrometryNetClass.html#astroquery.astrometry_net.AstrometryNetClass.monitor_submission">[docs]</a>
    <span class="k">def</span> <span class="nf">monitor_submission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission_id</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                           <span class="n">solve_timeout</span><span class="o">=</span><span class="n">TIMEOUT</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_submission_id</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Monitor the submission for completion.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        submission_id : ``int`` or ``str``</span>
<span class="sd">            Submission ID number from astrometry.net.</span>
<span class="sd">        solve_timeout : ``int``</span>
<span class="sd">            Time, in seconds, to wait for the astrometry.net solver to find</span>
<span class="sd">            a solution.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Whether to print out information about the solving.</span>
<span class="sd">        return_submission_id : bool, optional</span>
<span class="sd">            Whether to return the Submission ID number.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        None or `~astropy.io.fits.Header` or (`~astropy.io.fits.Header`, str)</span>
<span class="sd">            The contents of the returned object depend on whether the solve</span>
<span class="sd">            succeeds or fails. If the solve succeeds the header with</span>
<span class="sd">            the WCS solution generated by astrometry.net is returned. A tuple</span>
<span class="sd">            containing WCS solution and Submission ID is return if the</span>
<span class="sd">            return_submission_id parameter is set True. If the solve</span>
<span class="sd">            fails then an empty dictionary is returned. See below for the outcome</span>
<span class="sd">            if the solve times out.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>

<span class="sd">        ``TimeoutError``</span>
<span class="sd">            Raised if `astroquery.astrometry_net.AstrometryNetClass.TIMEOUT` is</span>
<span class="sd">            exceeded before the solve either succeeds or fails. The second</span>
<span class="sd">            argument in the exception is the submission ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">has_completed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Solving&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">has_completed</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sub_stat_url</span> <span class="o">=</span> <span class="n">url_helpers</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">API_URL</span><span class="p">,</span> <span class="s1">&#39;submissions&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">submission_id</span><span class="p">))</span>
            <span class="n">sub_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">sub_stat_url</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">sub_stat</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;jobs&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">jobs</span><span class="p">:</span>
                <span class="n">job_id</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">job_id</span><span class="p">:</span>
                <span class="n">job_stat_url</span> <span class="o">=</span> <span class="n">url_helpers</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">API_URL</span><span class="p">,</span> <span class="s1">&#39;jobs&#39;</span><span class="p">,</span>
                                                <span class="nb">str</span><span class="p">(</span><span class="n">job_id</span><span class="p">),</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span>
                <span class="n">job_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">job_stat_url</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">job_stat</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">timed_out</span> <span class="o">=</span> <span class="n">elapsed</span> <span class="o">&gt;</span> <span class="n">solve_timeout</span>
            <span class="n">has_completed</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="s1">&#39;failure&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">timed_out</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span>
            <span class="n">wcs_url</span> <span class="o">=</span> <span class="n">url_helpers</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">URL</span><span class="p">,</span> <span class="s1">&#39;wcs_file&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">job_id</span><span class="p">))</span>
            <span class="n">wcs_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">wcs_url</span><span class="p">)</span>
            <span class="n">wcs</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">wcs_response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;failure&#39;</span><span class="p">:</span>
            <span class="n">wcs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">elif</span> <span class="n">timed_out</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s1">&#39;Solve timed out without success or failure&#39;</span><span class="p">,</span>
                               <span class="n">submission_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Try to future-proof a little bit</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unrecognized status </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">return_submission_id</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wcs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">wcs</span><span class="p">,</span> <span class="n">submission_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="AstrometryNetClass.solve_from_source_list">
<a class="viewcode-back" href="../../../api/astroquery.astrometry_net.AstrometryNetClass.html#astroquery.astrometry_net.AstrometryNetClass.solve_from_source_list">[docs]</a>
    <span class="k">def</span> <span class="nf">solve_from_source_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">image_width</span><span class="p">,</span> <span class="n">image_height</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                               <span class="n">solve_timeout</span><span class="o">=</span><span class="n">TIMEOUT</span><span class="p">,</span>
                               <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">return_submission_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="o">**</span><span class="n">settings</span>
                               <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plate solve from a list of source positions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        x : list-like</span>
<span class="sd">            List of x-coordinate of source positions.</span>
<span class="sd">        y : list-like</span>
<span class="sd">            List of y-coordinate of source positions.</span>
<span class="sd">        image_width : int</span>
<span class="sd">            Size of the image in the x-direction.</span>
<span class="sd">        image_height : int</span>
<span class="sd">            Size of the image in the y-direction.</span>
<span class="sd">        solve_timeout : int</span>
<span class="sd">            Time, in seconds, to wait for the astrometry.net solver to find</span>
<span class="sd">            a solution.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Whether to print out information about the solving.</span>
<span class="sd">        return_submission_id : bool, optional</span>
<span class="sd">            Whether to return the Submission ID number.</span>

<span class="sd">        For a list of the remaining settings, use the method</span>
<span class="sd">        `~AstrometryNetClass.show_allowed_settings`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_login</span><span class="p">()</span>
        <span class="c1"># Add the settings required for solving from a source list to the list</span>
        <span class="c1"># after validating the common settings applicable in all cases.</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">y</span><span class="p">]</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;image_width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_width</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;image_height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_height</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session_id</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_payload</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url_helpers</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">API_URL</span><span class="p">,</span> <span class="s1">&#39;url_upload&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Post of job failed&#39;</span><span class="p">)</span>
        <span class="n">response_d</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">submission_id</span> <span class="o">=</span> <span class="n">response_d</span><span class="p">[</span><span class="s1">&#39;subid&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_submission</span><span class="p">(</span><span class="n">submission_id</span><span class="p">,</span>
                                       <span class="n">solve_timeout</span><span class="o">=</span><span class="n">solve_timeout</span><span class="p">,</span>
                                       <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                                       <span class="n">return_submission_id</span><span class="o">=</span><span class="n">return_submission_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="AstrometryNetClass.solve_from_image">
<a class="viewcode-back" href="../../../api/astroquery.astrometry_net.AstrometryNetClass.html#astroquery.astrometry_net.AstrometryNetClass.solve_from_image">[docs]</a>
    <span class="k">def</span> <span class="nf">solve_from_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_file_path</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">force_image_upload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">ra_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dec_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">ra_dec_units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">fwhm</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">detect_threshold</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                         <span class="n">solve_timeout</span><span class="o">=</span><span class="n">TIMEOUT</span><span class="p">,</span>
                         <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">return_submission_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plate solve from an image, either by uploading the image to</span>
<span class="sd">        astrometry.net or by finding sources locally using</span>
<span class="sd">        `photutils &lt;https://photutils.rtfd.io&gt;`_ and solving with source</span>
<span class="sd">        locations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        image_file_path : str or Path object</span>
<span class="sd">            Path to the image.</span>

<span class="sd">        force_image_upload : bool, optional</span>
<span class="sd">            If ``True``, upload the image to astrometry.net even if it is</span>
<span class="sd">            possible to detect sources in the image locally. This option will</span>
<span class="sd">            almost always take longer than finding sources locally. It will even</span>
<span class="sd">            take longer than installing photutils and then rerunning this.</span>

<span class="sd">            Even if this is ``False`` the image will be upload unless</span>
<span class="sd">            photutils is installed.</span>

<span class="sd">        ra_key : str, optional</span>
<span class="sd">            Name of the key in the FITS header that contains right ascension of the image.</span>
<span class="sd">            The ra can be specified using the ``center_ra`` setting instead if</span>
<span class="sd">            desired.</span>

<span class="sd">        dec_key : str, optional</span>
<span class="sd">            Name of the key in the FITS header that contains declination of the image.</span>
<span class="sd">            The dec can be specified using the ``center_dec`` setting instead if</span>
<span class="sd">            desired.</span>

<span class="sd">        ra_dec_units : tuple, optional</span>
<span class="sd">            Tuple specifying the units of the right ascension and declination in</span>
<span class="sd">            the header. The default value is ``(&#39;hour&#39;, &#39;degree&#39;)``.</span>

<span class="sd">        solve_timeout : int</span>
<span class="sd">            Time, in seconds, to wait for the astrometry.net solver to find</span>
<span class="sd">            a solution.</span>

<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Whether to print out information about the solving.</span>

<span class="sd">        return_submission_id : bool, optional</span>
<span class="sd">            Whether to return the Submission ID number.</span>

<span class="sd">        For a list of the remaining settings, use the method</span>
<span class="sd">        `~AstrometryNetClass.show_allowed_settings`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ra_key</span> <span class="ow">and</span> <span class="n">dec_key</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">hdr</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
                <span class="c1"># The error here if one of these fails should be pretty clear</span>
                <span class="n">ra</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="n">ra_key</span><span class="p">]</span>
                <span class="n">dec</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="n">dec_key</span><span class="p">]</span>
                <span class="c1"># Convert these to degrees in appropriate range</span>
                <span class="n">center</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="s1">&#39;degree&#39;</span><span class="p">))</span>
                <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;center_ra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">degree</span>
                <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;center_dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">degree</span>

        <span class="n">settings</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">force_image_upload</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_no_source_detector</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_login</span><span class="p">()</span>
            <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session_id</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_payload</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">url_helpers</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">API_URL</span><span class="p">,</span> <span class="s1">&#39;upload&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">image_file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
                                         <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                         <span class="n">files</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="n">f</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Detect sources and delegate to solve_from_source_list</span>
            <span class="k">if</span> <span class="n">_HAVE_CCDDATA</span><span class="p">:</span>
                <span class="c1"># CCDData requires a unit, so provide one. It has absolutely</span>
                <span class="c1"># no impact on source detection. The reader for CCDData</span>
                <span class="c1"># tries to find the first ImageHDU in a FITS file, so it</span>
                <span class="c1"># is the preferred way to get the data.</span>
                <span class="n">ccd</span> <span class="o">=</span> <span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">image_file_path</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;adu&#39;</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Determining background stats&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
                                                    <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="n">fwhm</span><span class="p">,</span>
                                    <span class="n">threshold</span><span class="o">=</span><span class="n">detect_threshold</span> <span class="o">*</span> <span class="n">std</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding sources&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sources</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">median</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found </span><span class="si">{}</span><span class="s1"> sources&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># astrometry.net wants a sorted list of sources</span>
            <span class="c1"># Sort first (which puts things in ascending order)</span>
            <span class="n">sources</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">)</span>
            <span class="c1"># Reverse to get descending order</span>
            <span class="n">sources</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>

            <span class="c1"># It turns out astrometry.net is 1-indexed, so add 1 to the source positions.</span>
            <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_from_source_list</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span>
                                               <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">],</span>
                                               <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;naxis1&#39;</span><span class="p">],</span>
                                               <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;naxis2&#39;</span><span class="p">],</span>
                                               <span class="n">solve_timeout</span><span class="o">=</span><span class="n">solve_timeout</span><span class="p">,</span>
                                               <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                                               <span class="n">return_submission_id</span><span class="o">=</span><span class="n">return_submission_id</span><span class="p">,</span>
                                               <span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Post of job failed&#39;</span><span class="p">)</span>
        <span class="n">response_d</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">submission_id</span> <span class="o">=</span> <span class="n">response_d</span><span class="p">[</span><span class="s1">&#39;subid&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_submission</span><span class="p">(</span><span class="n">submission_id</span><span class="p">,</span>
                                       <span class="n">solve_timeout</span><span class="o">=</span><span class="n">solve_timeout</span><span class="p">,</span>
                                       <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                                       <span class="n">return_submission_id</span><span class="o">=</span><span class="n">return_submission_id</span><span class="p">)</span></div>
</div>



<span class="c1"># the default tool for users to interact with is an instance of the Class</span>
<span class="n">AstrometryNet</span> <span class="o">=</span> <span class="n">AstrometryNetClass</span><span class="p">()</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2023, The Astroquery Developers.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 7.2.6. &nbsp;
    Last built 11 Dec 2023. <br/>
  </p>
</footer>
  </body>
</html>