<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>astroquery.besancon.core &#8212; astroquery v0.4.7.dev9024</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-astropy.css?v=9d21690f" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    
    <script src="../../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../../_static/documentation_options.js?v=4195d067"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="icon" href="../../../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">astro</span><span id="logotext2">query</span><span id="logotext3">:docs</span></a>
  <ul>
    
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">astroquery v0.4.7.dev9024</a>
	 &#187;
      </li>
      <li><a href="../../index.html" >Module code</a> &#187;</li>
      <li><a href="../besancon.html" accesskey="U">astroquery.besancon</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for astroquery.besancon.core</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>

<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">ascii</span>
<span class="kn">from</span> <span class="nn">urllib.error</span> <span class="kn">import</span> <span class="n">URLError</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">..query</span> <span class="kn">import</span> <span class="n">BaseQuery</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">commons</span><span class="p">,</span> <span class="n">prepend_docstr_nosections</span><span class="p">,</span> <span class="n">async_to_sync</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">conf</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Besancon&#39;</span><span class="p">,</span> <span class="s1">&#39;BesanconClass&#39;</span><span class="p">,</span> <span class="s1">&#39;parse_besancon_model_string&#39;</span><span class="p">]</span>

<span class="n">keyword_defaults</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;rinf&#39;</span><span class="p">:</span> <span class="mf">0.000000</span><span class="p">,</span>
    <span class="s1">&#39;rsup&#39;</span><span class="p">:</span> <span class="mf">50.000000</span><span class="p">,</span>
    <span class="s1">&#39;dist_step_mode&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;dlr&#39;</span><span class="p">:</span> <span class="mf">0.000</span><span class="p">,</span>
    <span class="s1">&#39;kleg&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;longit&#39;</span><span class="p">:</span> <span class="mf">10.62</span><span class="p">,</span>
    <span class="s1">&#39;latit&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.38</span><span class="p">,</span>
    <span class="s1">&#39;soli&#39;</span><span class="p">:</span> <span class="mf">0.0003</span><span class="p">,</span>  <span class="c1"># degrees.  0.00027777 = 1 arcsec</span>
    <span class="s1">&#39;kleh&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;eq1&#39;</span><span class="p">:</span> <span class="mf">2000.0</span><span class="p">,</span>
    <span class="s1">&#39;al0&#39;</span><span class="p">:</span> <span class="mf">200.00</span><span class="p">,</span>
    <span class="s1">&#39;alm&#39;</span><span class="p">:</span> <span class="mf">200.00</span><span class="p">,</span>
    <span class="s1">&#39;dl&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;ab0&#39;</span><span class="p">:</span> <span class="mf">59.00</span><span class="p">,</span>
    <span class="s1">&#39;abm&#39;</span><span class="p">:</span> <span class="mf">59.00</span><span class="p">,</span>
    <span class="s1">&#39;db&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;adif&#39;</span><span class="p">:</span> <span class="mf">0.700</span><span class="p">,</span>
    <span class="s1">&#39;ev&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">25</span><span class="p">,</span>
    <span class="s1">&#39;AV&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">25</span><span class="p">,</span>
    <span class="s1">&#39;di&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">25</span><span class="p">,</span>
    <span class="s1">&#39;oo&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">99</span><span class="p">]</span> <span class="o">*</span> <span class="mi">12</span><span class="p">,</span>
    <span class="s1">&#39;ff&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">99</span><span class="p">]</span> <span class="o">*</span> <span class="mi">12</span><span class="p">,</span>
    <span class="s1">&#39;spectyp_min&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;subspectyp_min&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;spectyp_max&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
    <span class="s1">&#39;subspectyp_max&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s1">&#39;lumi&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">)),</span>
    <span class="s1">&#39;sous_pop&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)),</span>
    <span class="s1">&#39;iband&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;band0&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">*</span> <span class="mi">9</span><span class="p">,</span>
    <span class="s1">&#39;bandf&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">*</span> <span class="mi">9</span><span class="p">,</span>
    <span class="s1">&#39;colind&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;B-V&quot;</span><span class="p">,</span> <span class="s2">&quot;U-B&quot;</span><span class="p">,</span> <span class="s2">&quot;V-I&quot;</span><span class="p">,</span> <span class="s2">&quot;V-K&quot;</span><span class="p">,</span> <span class="p">],</span>
    <span class="s1">&#39;nic&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s1">&#39;klea&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;sc&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">9</span><span class="p">,</span>
    <span class="s1">&#39;klee&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;throughform&#39;</span><span class="p">:</span> <span class="s1">&#39;ok&#39;</span><span class="p">,</span>
    <span class="s1">&#39;kleb&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># 3 = Catalogue Simulation, 1 = tables and differential counts</span>
    <span class="s1">&#39;klec&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># 1 = ubv, 15= cfhtls (photometric system)</span>
    <span class="s1">&#39;cinem&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 0: no kinematics, 1: kinematics</span>
    <span class="s1">&#39;outmod&#39;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">keyword_defaults</span><span class="p">[</span><span class="s1">&#39;ff[15]&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">keyword_defaults</span><span class="p">[</span><span class="s1">&#39;oo[15]&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">500</span>

<span class="n">colors_limits</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">ci</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="mi">99</span><span class="p">))</span>
                            <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="n">keyword_defaults</span><span class="p">[</span><span class="s1">&#39;colind&#39;</span><span class="p">])</span>
<span class="n">mag_limits</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;U&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="mi">99</span><span class="p">),</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="mi">99</span><span class="p">),</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span> <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="mi">99</span><span class="p">),</span>
              <span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="mi">99</span><span class="p">),</span> <span class="s1">&#39;J&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="mi">99</span><span class="p">),</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="mi">99</span><span class="p">),</span> <span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="mi">99</span><span class="p">),</span>
              <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="mi">99</span><span class="p">)}</span>

<span class="n">mag_order</span> <span class="o">=</span> <span class="s2">&quot;VBURIJHKL&quot;</span>


<div class="viewcode-block" id="BesanconClass">
<a class="viewcode-back" href="../../../api/astroquery.besancon.BesanconClass.html#astroquery.besancon.BesanconClass">[docs]</a>
<span class="nd">@async_to_sync</span>
<span class="k">class</span> <span class="nc">BesanconClass</span><span class="p">(</span><span class="n">BaseQuery</span><span class="p">):</span>

    <span class="c1"># Since these are configuration options, they should probably be used</span>
    <span class="c1"># directly rather than re-stored as local variables. Then again, we need</span>
    <span class="c1"># to refactor this whole project to be class-based, so they should be</span>
    <span class="c1"># set for class instances.</span>

    <span class="n">url_download</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">download_url</span>
    <span class="n">QUERY_URL</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">model_form</span>
    <span class="n">ping_delay</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">ping_delay</span>
    <span class="n">TIMEOUT</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">timeout</span>
    <span class="c1"># sample file name:  1340900648.230224.resu</span>
    <span class="n">result_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[0-9]</span><span class="si">{10}</span><span class="s2">\.[0-9]</span><span class="si">{6}</span><span class="s2">\.resu&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>

<div class="viewcode-block" id="BesanconClass.get_besancon_model_file">
<a class="viewcode-back" href="../../../api/astroquery.besancon.BesanconClass.html#astroquery.besancon.BesanconClass.get_besancon_model_file">[docs]</a>
    <span class="k">def</span> <span class="nf">get_besancon_model_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download a Besancon model from the website.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : string</span>
<span class="sd">            The besancon filename, with format ##########.######.resu</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            Print details about the download process</span>
<span class="sd">        timeout : float</span>
<span class="sd">            Amount of time to wait after pinging the server to see if a file is</span>
<span class="sd">            present.  Default 5s, which is probably reasonable.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url_download</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">elapsed_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Awaiting Besancon file...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">commons</span><span class="o">.</span><span class="n">get_readable_fileobj</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">remote_timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                                                  <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="n">URLError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;Waiting </span><span class="si">%0.1f</span><span class="s2">s for model to finish&quot;</span>
                                     <span class="s2">&quot; (elapsed wait time </span><span class="si">%0.1f</span><span class="s2">s, total &quot;</span>
                                     <span class="s2">&quot;wait time </span><span class="si">%0.1f</span><span class="s2">)</span><span class="se">\r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ping_delay</span><span class="p">,</span>
                                                             <span class="n">elapsed_time</span><span class="p">,</span>
                                                             <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ping_delay</span><span class="p">)</span>
                <span class="n">elapsed_time</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ping_delay</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;Waiting </span><span class="si">%0.1f</span><span class="s2">s for model to finish &quot;</span>
                                     <span class="s2">&quot;(elapsed wait time </span><span class="si">%0.1f</span><span class="s2">s, total wait &quot;</span>
                                     <span class="s2">&quot;time </span><span class="si">%0.1f</span><span class="s2">)</span><span class="se">\r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ping_delay</span><span class="p">,</span>
                                                        <span class="n">elapsed_time</span><span class="p">,</span>
                                                        <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ping_delay</span><span class="p">)</span>
                <span class="n">elapsed_time</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ping_delay</span>
                <span class="k">continue</span>

        <span class="k">return</span> <span class="n">parse_besancon_model_string</span><span class="p">(</span><span class="n">results</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_parse_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">retrieve_file</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        retrieve_file : bool</span>
<span class="sd">            If True, will try to retrieve the file every 30s until it shows up.</span>
<span class="sd">            Otherwise, just returns the filename (the job is still executed on</span>
<span class="sd">            the remote server, though)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading request from Besancon server ...&quot;</span><span class="p">)</span>

        <span class="c1"># keep the text stored for possible later use</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c1"># if there are no matches</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="n">parse_errors</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Errors: &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File is </span><span class="si">{0}</span><span class="s2"> and can be acquired from </span><span class="si">{1}</span><span class="s2">&quot;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_download</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">retrieve_file</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_besancon_model_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">filename</span>

    <span class="k">def</span> <span class="nf">_parse_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glon</span><span class="p">,</span> <span class="n">glat</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">smallfield</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">extinction</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                    <span class="n">area</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clouds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">absmag_limits</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">mag_limits</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mag_limits</span><span class="p">),</span>
                    <span class="n">colors_limits</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">colors_limits</span><span class="p">),</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a query on the Besancon model of the galaxy.</span>

<span class="sd">        https://model.obs-besancon.fr/</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        glon : float</span>
<span class="sd">        glat : float</span>
<span class="sd">            Galactic latitude and longitude at the center</span>
<span class="sd">        email : str</span>
<span class="sd">            A valid e-mail address to send the report of completion to</span>
<span class="sd">        smallfield : bool</span>
<span class="sd">            Small field (True) or Large Field (False)</span>
<span class="sd">            LARGE FIELD NOT SUPPORTED YET</span>
<span class="sd">        extinction : float</span>
<span class="sd">            Extinction per kpc in A_V</span>
<span class="sd">        area : float</span>
<span class="sd">            Area in square degrees</span>
<span class="sd">        absmag_limits : (float,float)</span>
<span class="sd">            Absolute magnitude lower,upper limits</span>
<span class="sd">        colors_limits : dict of (float,float)</span>
<span class="sd">            Should contain 4 elements listing color differences in the valid</span>
<span class="sd">                bands, e.g.:</span>
<span class="sd">                {&quot;J-H&quot;:(99,-99),&quot;H-K&quot;:(99,-99),&quot;J-K&quot;:(99,-99),&quot;V-K&quot;:(99,-99)}</span>
<span class="sd">        mag_limits = dict of (float,float)</span>
<span class="sd">            Lower and Upper magnitude difference limits for each magnitude band</span>
<span class="sd">            U B V R I J H K L</span>
<span class="sd">        clouds : list of 2-tuples</span>
<span class="sd">            Up to 25 line-of-sight clouds can be specified in pairs of (A_V,</span>
<span class="sd">            distance in pc)</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            Print out extra error messages?</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            Can override any argument in the request if you know the name of</span>
<span class="sd">            the POST keyword.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Either the filename or the table depending on whether &#39;retrieve</span>
<span class="sd">        file&#39; is specified</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">email</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">):</span>
            <span class="n">email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">email</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="ow">or</span> <span class="ow">not</span> <span class="n">commons</span><span class="o">.</span><span class="n">validate_email</span><span class="p">(</span><span class="n">email</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must specify a valid e-mail address.&quot;</span><span class="p">)</span>

        <span class="c1"># create a new keyword dict based on inputs + defaults</span>
        <span class="n">kwd</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">keyword_defaults</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keyword_defaults</span><span class="p">:</span>
                <span class="n">kwd</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">elif</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;retrieve_file&#39;</span><span class="p">,):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipped invalid key </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

        <span class="n">kwd</span><span class="p">[</span><span class="s1">&#39;kleg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">smallfield</span> <span class="k">else</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">smallfield</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="n">kwd</span><span class="p">[</span><span class="s1">&#39;longit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">glon</span>
        <span class="n">kwd</span><span class="p">[</span><span class="s1">&#39;latit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">glat</span>

        <span class="n">kwd</span><span class="p">[</span><span class="s1">&#39;adif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extinction</span>
        <span class="n">kwd</span><span class="p">[</span><span class="s1">&#39;soli&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">area</span>
        <span class="n">kwd</span><span class="p">[</span><span class="s1">&#39;oo&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">absmag_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">kwd</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">absmag_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">colors_limits</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">mag_order</span> <span class="ow">and</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span> <span class="ow">and</span> <span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">mag_order</span><span class="p">:</span>
                <span class="n">kwd</span><span class="p">[</span><span class="s1">&#39;colind&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
                <span class="n">kwd</span><span class="p">[</span><span class="s1">&#39;oo&#39;</span><span class="p">][</span><span class="n">index</span> <span class="o">+</span> <span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">kwd</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">][</span><span class="n">index</span> <span class="o">+</span> <span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid color </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">mag_limits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mag_order</span><span class="p">:</span>
                <span class="n">kwd</span><span class="p">[</span><span class="s1">&#39;band0&#39;</span><span class="p">][</span><span class="n">mag_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">kwd</span><span class="p">[</span><span class="s1">&#39;bandf&#39;</span><span class="p">][</span><span class="n">mag_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid band </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">clouds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">AV</span><span class="p">,</span> <span class="n">di</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clouds</span><span class="p">):</span>
                <span class="n">kwd</span><span class="p">[</span><span class="s1">&#39;AV&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">AV</span>
                <span class="n">kwd</span><span class="p">[</span><span class="s1">&#39;di&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">di</span>

        <span class="c1"># parse the default dictionary</span>
        <span class="c1"># request_data = parse_besancon_dict(keyword_defaults)</span>
        <span class="n">request_data</span> <span class="o">=</span> <span class="n">kwd</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># convert all array elements to arrays</span>
        <span class="k">for</span> <span class="n">dummy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>  <span class="c1"># deal with nested lists</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">request_data</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">request_data</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">request_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                        <span class="n">request_data</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">[</span><span class="si">%i</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="c1"># an e-mail address is required</span>
        <span class="n">request_data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email</span>

        <span class="k">return</span> <span class="n">request_data</span>

<div class="viewcode-block" id="BesanconClass.query_async">
<a class="viewcode-back" href="../../../api/astroquery.besancon.BesanconClass.html#astroquery.besancon.BesanconClass.query_async">[docs]</a>
    <span class="nd">@prepend_docstr_nosections</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">_parse_args</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">+</span> <span class="n">_parse_result</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">query_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        response : `requests.Response` object</span>
<span class="sd">            The response of the HTTP request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_args</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;get_query_payload&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">data_payload</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">QUERY_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_payload</span><span class="p">,</span>
                                 <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div>
</div>



<span class="n">Besancon</span> <span class="o">=</span> <span class="n">BesanconClass</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">parse_besancon_dict</span><span class="p">(</span><span class="n">bd</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Turn a dict like default_keys into a list of tuples.</span>

<span class="sd">    Must be a list of tuples because there are some repeated entries,</span>
<span class="sd">    which dictionaries do not support.</span>

<span class="sd">    .. todo::</span>
<span class="sd">        In the future, a better way to do this is to make each dict entry a</span>
<span class="sd">        list; requests knows how to deal with this properly</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">http_dict</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">bd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;[]&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">listval</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                    <span class="n">http_dict</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">listval</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">listval</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">listval</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">inner_index</span><span class="p">,</span> <span class="n">inner_listval</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">listval</span><span class="p">):</span>
                            <span class="n">http_dict</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;[</span><span class="si">%i</span><span class="s2">][</span><span class="si">%i</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">inner_index</span><span class="p">),</span> <span class="n">inner_listval</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">http_dict</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;[</span><span class="si">%i</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">listval</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">http_dict</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">http_dict</span>


<span class="k">def</span> <span class="nf">parse_errors</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attempt to extract the errors from a Besancon web page with error</span>
<span class="sd">    messages in it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;&lt;div\ class=&quot;?errorpar&quot;?&gt;\s*</span>
<span class="s2">                        &lt;ol&gt;\s*</span>
<span class="s2">                        (&lt;li&gt;([a-zA-Z0-9):( \s_-]*)&lt;/li&gt;\s*)*\s*</span>
<span class="s2">                        &lt;/ol&gt;\s*</span>
<span class="s2">                        &lt;/div&gt;&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Regular expression matching to error &quot;</span>
                         <span class="s2">&quot;message failed.&quot;</span><span class="p">)</span>
    <span class="n">text_items</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;li&gt;|&lt;/li&gt;|\n&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>
    <span class="n">text_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">text_items</span> <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
    <span class="n">error_list</span> <span class="o">=</span> <span class="n">text_items</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">error_list</span>


<div class="viewcode-block" id="parse_besancon_model_file">
<a class="viewcode-back" href="../../../api/astroquery.besancon.parse_besancon_model_file.html#astroquery.besancon.parse_besancon_model_file">[docs]</a>
<span class="k">def</span> <span class="nf">parse_besancon_model_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse a besancon model from a file on disk</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">parse_besancon_model_string</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span></div>



<div class="viewcode-block" id="parse_besancon_model_string">
<a class="viewcode-back" href="../../../api/astroquery.besancon.parse_besancon_model_string.html#astroquery.besancon.parse_besancon_model_string">[docs]</a>
<span class="k">def</span> <span class="nf">parse_besancon_model_string</span><span class="p">(</span><span class="n">bms</span><span class="p">,):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given an entire Besancon model result in *string* form, parse it into an</span>
<span class="sd">    `~astropy.table.Table`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">header_start</span> <span class="o">=</span> <span class="s2">&quot;Dist    Mv  CL&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="c1"># locate index of data start</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">bms</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">nblanks1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">nblanks1</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">h</span> <span class="ow">in</span> <span class="n">line</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">header_start</span><span class="p">]):</span>
            <span class="k">break</span>

    <span class="n">names</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
    <span class="n">header_line</span> <span class="o">=</span> <span class="n">index</span>
    <span class="c1"># data starts 1 line after header</span>
    <span class="n">first_data_line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">header_line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="c1"># apparently ascii wants you to start 1 early though</span>
    <span class="n">data_start</span> <span class="o">=</span> <span class="n">header_line</span>
    <span class="c1"># ascii.read ignores blank lines</span>
    <span class="n">data_start</span> <span class="o">-=</span> <span class="n">nblanks1</span>

    <span class="c1"># locate index of data end</span>
    <span class="n">nblanks2</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">data_index</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="s2">&quot;TOTAL NUMBER OF STARS :&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">nstars</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">nblanks2</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">h</span> <span class="ow">in</span> <span class="n">line</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">header_start</span><span class="p">]):</span>
            <span class="k">break</span>
    <span class="c1"># most likely = -7</span>
    <span class="n">data_end</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">data_index</span> <span class="o">-</span> <span class="n">nblanks2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># note: old col_starts/col_ends were:</span>
    <span class="c1"># (0,7,13,16,21,27,33,36,41,49,56,62,69,76,82,92,102,109)</span>
    <span class="c1"># (6,12,15,20,26,32,35,39,48,55,61,68,75,81,91,101,108,115)</span>
    <span class="n">space_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">first_data_line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">ii</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">first_data_line</span><span class="p">))]</span>
    <span class="n">col_ends</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">space_indices</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">space_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">if</span> <span class="n">y</span> <span class="o">-</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">space_indices</span><span class="p">)]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">col_ends</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">col_ends</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Failed to parse Besancon table header.&quot;</span><span class="p">)</span>
    <span class="n">col_starts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">col_ends</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_starts</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ncols</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_ends</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ncols</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Table parsing error: mismatch between # of &quot;</span>
                         <span class="s2">&quot;columns &amp; header&quot;</span><span class="p">)</span>

    <span class="n">besancon_table</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">bms</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;fixed_width_no_header&#39;</span><span class="p">,</span>
                                <span class="n">data_start</span><span class="o">=</span><span class="n">data_start</span><span class="p">,</span> <span class="n">data_end</span><span class="o">=</span><span class="n">data_end</span><span class="p">,</span>
                                <span class="n">col_starts</span><span class="o">=</span><span class="n">col_starts</span><span class="p">,</span> <span class="n">col_ends</span><span class="o">=</span><span class="n">col_ends</span><span class="p">,</span>
                                <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span> <span class="n">fast_reader</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">besancon_table</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nstars</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Besancon table did not match reported size&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">cn</span> <span class="ow">in</span> <span class="n">besancon_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">besancon_table</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The Besancon table did not parse properly.  &quot;</span>
                          <span class="s2">&quot;Some columns are likely to have invalid &quot;</span>
                          <span class="s2">&quot;values and others incorrect values.  &quot;</span>
                          <span class="s2">&quot;Please report this error.&quot;</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">besancon_table</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2023, The Astroquery Developers.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 7.2.6. &nbsp;
    Last built 11 Dec 2023. <br/>
  </p>
</footer>
  </body>
</html>